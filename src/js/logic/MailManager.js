/* src/js/logic/MailManager.js */
import { UserData } from '../data/UserData.js';
import { StoryManager } from './StoryManager.js';
import { HUDRenderer } from '../ui/HUDRenderer.js'; // ✨ 新增引入：用于显示Toast

export const MailManager = {
    // 📖 21天信件库 (剧本配置)
letters: {
        // === 第一周：叙事 ===
        1: {
            title: "半年了",
            sender: "糖水菠萝",
            // 使用 Markdown 格式增强阅读体验
            content: `To ???：
距离离职已经过了半年了。

想把这半年的经历整理一下，但是写给谁呢？我知道，理智的声音会说：“当然是写给自己啊，书写是为了内省。”

但人总归是软弱的动物。如果只是写给自己看，我总觉得像是在对着枯井喊话，回声只会让自己更显孤独。我觉得每个人都或多或少希望向别人分享自己的故事吧？

所以，假想一个听众也不是坏事。

还有半年，这间房子的租期就到了。按照概率，总会有下一个人的。那就不妨选你吧，未来的新房客。

其实离职之后，我就恢复了记日记的习惯……

（涂改的痕迹……信到这里就结束了）`
// 未来可以设置一个反应弹窗，引导用户“‘到这里就没有了，好奇怪’你心想”；同时可以埋一个钩子，在支线里补上“信的后续内容”。
        },
        2: {
            title: "寄错了！！！",
            sender: "糖水菠萝",
            content: `To 新房客：
刚才整理书桌时我才发现，我原本准备寄给你的“入住欢迎信”还夹在书里。

那我昨天扔进邮筒的那封……
天哪，那一封是什么呀？

我平时有在废纸上乱写乱画的习惯。是超市购物清单？是半夜写的一句废话？还是我离职那天写的发疯文学？

坏了，我自己也不知道。

总之，不管你收到了什么，请忘掉它吧？

咳咳，重来一次。这里才是第一封！

你好，新房客。我是你的前任室友，你可以叫我“糖水菠萝”。

既然那个尴尬的开头已经发生了（虽然我不知道到底有多尴尬），或许这也是一种缘分？

那么，这封欢迎信要写些什么呢？

不知道你有没有翻过书架，书架的最底层有一本书——《伊萨卡手记》。

我刚搬进来时，在书架的最底层发现了它。嘿嘿，所以我也把它放回了书架最底层。扉页上写着一句话，我至今都背得下来：

“一个在过去、现在和未来的筹划中定位自己，具有语言能力的成年人是在叙事中展开他的行动和生活的”

在我失业的那段日子里，我按照《伊萨卡手记》的建议开始去有意识地尝试书写自己的故事——神奇的事情发生了：当我把那些混乱的情绪变成文字，把无意义的日常变成故事的时候，我发现我不再是一个被生活推着走的配角，我夺回了叙事权。

书写，就是建造你内心的伊萨卡岛。

但不幸的是，因为一些小小的意外（以后告诉你），这部书的大部分内容都遗失了，所以我觉得我有责任把这部书的内容传递给你！

当然当然，如果你不感兴趣也没有关系哦，反正还可以把这些信的背后拿来当草稿纸，也可以用来折纸飞机。今天就先写到这里吧。强烈安利先把现有的内容看一看。

祝 笔尖自由。`
        },
        3: {
            title: "今天聊聊理论",
            sender: "糖水菠萝",
            content: `To 新房客：
《伊萨卡手记》的第一章主题是“叙事与自我”。
说实话，在没读那本书之前，我就隐隐约约觉得，每个人其实都是一位“作家”。

具体来说，我们每天都在书写两样东西：一个是“过去”，一个是“未来”。

你可能会问了：“过去”都已经发生了，还能书写吗？

诚然，事情的“结果”无法改变，但我们对事情的“理解”却可以——这就是“书写”成立的前提。

咱们有句老话叫“塞翁失马，焉知非福”。
马丢了，当时看是“损失”；但后来它带回了另一匹好马，丢失就变成了“福气”。
你看，虽然事实（马丢了）没变，但随着时间推移，事件的意义发生了反转。

这里面有必然的因果逻辑吗？丢一匹马就一定会得两匹马？显然没有。
是我们运用了“叙事”，把两个独立的事件连成了一个关于“转机”的故事。

科学处理的是“事实”，而叙事处理的是“意义”。
我们之所以需要叙事，是因为人是活在“意义”里的动物。

这也很自然地把我们带到了对未来的讨论。
还是“塞翁失马”，这其实也是在书写未来——它告诫我们，当下的坏事也许没那么坏，未来总有转机。

不过，我要强调的是：当我们谈论“叙事”时，不仅仅是在讲故事，而是在谈论一种有意识的行动。

你会问：这不就是所谓的“复盘”吗？

现在的确很流行说“复盘”。你可能以为我会批判它，说“复盘是冷冰冰的优绩主义，叙事才是温暖的存在主义”之类的……

不，我觉得这是一种误解。

在我看来，不论是“优绩主义”还是“存在主义”，并没有绝对的高下之分。
它们本质上都是一种叙事方式。

采纳“优绩主义”的叙事，可能是因为过去的成功让你体会到了被认可的喜悦；
采纳“存在主义”的叙事，可能是因为被生活的压力逼得喘不过气，需要寻找新的出口。

关键不在于哪个主义更好，而在于——
你需要发现自己正活在哪个剧本里？这个剧本对现在的你来说，逻辑自洽吗？它让你痛苦还是快乐？

……

啊啊啊啊，好严肃……

我怎么突然开始上课了！明明是想写信聊天的！
果然理论还是太沉重了。

也许明天直接讲讲我自己的故事，会更轻松些！

——糖水菠萝`
        },
        4: {
            title: "一个失败的人的故事（上）",
            sender: "糖水菠萝",
            content: `To 新房客：
我猜，你应该和我一样，也是刚毕业不久的大学生吧？

如果不幸言中，那我们握个手；如果不是，也没关系，因为“成功与失败”是人类永恒的八卦主题。

我想问你一个问题：在你心里，“成功”长什么样？

不需要太复杂的描述，我闭着眼睛都能画出它的画像——
如果他是男的，他大概叫“小明”。由于长相帅气、谈吐不凡，他在大学里就是学生会主席或者什么社团负责人，奖学金获得者，毕业后无缝衔接进入大厂，三年年薪百万，五年实现财富自由。
如果她是女的，她大概叫“小红”。她精致漂亮，朋友圈里永远是高端的下午茶和说走就走的旅行，家庭美满，事业有成。

他们是那种“Outstanding ones”，是老师口中的“杰出校友”，是过年回家亲戚嘴里的“别人家的孩子”。

有时候走在写字楼林立的CBD，看着玻璃幕墙反射的光，我会觉得这个世界就是为“小明”和“小红”们设计的。

而我呢？

仔细想想，虽然这个世界上确实有很多“小明”和“小红”，但大部分人都只是背景板里的路人甲。

不过……我也曾有过幻想。有一段时间，我确实觉得我已经拿到了通往“小明”世界的入场券。

毕业后，我也成功进了大厂。而且不瞒你说，第一年我还是模范员工呢！
PPT做得花团锦簇，日报写得洋洋洒洒，早到晚退，那是我的标配。

但是到了第二年，你猜怎么着？
就像是一台机器突然被拔掉了电源，我整个人完全没有了工作的热情。

从原本的早到晚退，变成了卡点上班、早早溜号。
坐在工位上，屏幕里是代码，脑子里却是空的。刷漫画、看小说、玩游戏，工作能拖就拖，最后甚至变成了“能不干就不干”。

结果当然毫无悬念——我被裁了，hhh。

从“模范员工”到“被裁员”，只用了一年。
你说为什么？

让我们下一封接着聊~`
        },
        5: {
            title: "一个失败的人的故事（中）",
            sender: "糖水菠萝",
            content: `To 新房客：
书接上回。为什么我会从“模范员工”变成“摆烂之王”？

如果你学过社会学，或者只要你在网上冲过浪，你可能会脱口而出那个词：**“异化”**。
因为那不是你真正想要的生活，所以你潜意识里在通过“摆烂”来反抗。

好吧，我在之前确实给过一个这样的解释，而且有机会我要详细展开来讲一讲。
写到这里就想到《悲惨世界》里冉·阿让说的话——好吧，虽然是反过来，社会有“错”，但是难道自己就没有“错”吗？

也就是在这里，我觉得“叙事”的力量开始发挥出来了。
与其纠结谁对谁错，不如把那个被我弄丢了的“作家”找回来。

当那个理性与感性兼具的作家回来后，他看着这段名为“过去”的素材，开始思考未来的剧本该怎么写。
写到这里，我脑子里不禁蹦出了那个经典的“萧火火”剧本：
“三十年河东，三十年河西，莫欺少年穷！”

未来要不要安排一波痛快的“逆袭”情节？比如创业成功，狠狠打脸前东家？

我不知道。

什么？你说你不知道？
我猜你肯定会这么问。毕竟在大家的印象里，故事的主角总该有个目标吧。

但我真的不知道。
因为我觉得，“叙事”并不是简单地否定掉过去的某个剧本，然后投入到另一个完全相反的剧本里。
难道因为“优绩主义”让我痛苦，它就全是坏东西吗？我们就要像泼脏水一样把它全部倒掉吗？

并不是啊。
说实话，我至今都觉得被裁员还是蛮可惜的（如果我当时更机智地摸鱼就好了hhh）。

那么，什么才是“好的叙事”呢？

我现在觉得，好的叙事必然是一种“整合”。
所谓整合，就是把“第一人称（我）”“第二人称（你）”和“第三人称（他）”的视角统一起来。

先说第一人称（我自己）：
我其实并不反感“成功”。被认可、被夸奖、获得成就感，这本来就是让人快乐的事，没必要因为批判优绩主义就假装自己不喜欢赢。

再说第二人称（你）：
可惜没办法收到你的回信，不过因为假想着有一个“你”在读，我才能把这些混乱的念头理顺。“你”是我的见证者。当故事被讲述给某个人听时，它有了形状。（如果能够有回应它也会发生改变！）

最后说第三人称（社会）：
要在社会立足，我们需要“头衔”，需要接受一定的工作伦理。这是游戏的规则。

问题在于，之前的我，只活在“第三人称”里；而后来摆烂的我，只顾着“第一人称”的爽。
至于“第二人称”？那时我根本没有朋友，也没有倾诉的对象，我活在一个封闭的孤岛上。

彻底服膺于任何一方的剧本，必然会走向悲剧。
虽然这两个视角的张力可能永远无法消除，但我想要试着……把它们拉到一张桌子上。

至于具体怎么做？
这也是我正在探索的。
让我们下次接着聊！
            `
        },
        6: {
            title: "一个失败的人的故事（下）",
            sender: "糖水菠萝",
            content: `To 新房客：
嘿，我又回来啦！

其实我觉得……人还是要“卷”，要“努力”。
但不是为了成为“小明”或“小红”而卷，而是在自己真正热爱且有天赋的领域里努力。

正如我上一封信说的那样，一个自洽的叙事，一定是将“我”、“你”、“他”三者整合起来的。
从我失业一年的时间算起，我好像把这块拼图拼上了：

关于“我”（热爱）：
在待业的这半年里，我尝试了很多事。我发现我还是离不开故事。我狂热地痴迷于阅读，并且发现自己有一种奇怪的天赋——我能把那些枯燥的社会学理论，变成好玩的游戏机制。
我现在正在开发一款恋爱视觉小说（试图把爱情社会学的知识塞进去，诶嘿）。

关于“你”（见证）：
记得我提到过的“局外见证人”吗？
前段时间，我把做好的Demo传到了 itch.io 上。我本以为会石沉大海，结果竟然收到了好多陌生人的留言！
有人说“被治愈了”，有人说“原来我也不是一个人”。
那一刻，我感觉到了“你”的存在。我的故事被听见了。

关于“他”（社会）：
这就是最神奇的地方。
因为那个Demo的口碑，G市的一家独立游戏工作室联系了我。他们认可我的能力，邀请我加入。

我现在人已经在G市了。
不过……我还不打算把新地址告诉你。等一切安顿下来，再决定要不要把地址发给你吧！`
        },
        7: {
            title: "叙事与自我",
            sender: "糖水菠萝",
            content: `To 新房客：
好家伙！破案了！

还记得我在第二封信里跟你说的那个“导致书页遗失的小意外”吗？
刚才我在新租的房子里整理行李，在一箱旧衣服的最底下，发现了一叠被压得皱皱巴巴的纸。

我拿起来一看——
这就是《伊萨卡手记》失踪的第二章啊！

原来是我搬家的时候，顺手把它夹在画册里带走了……
（甚至上面还有一圈咖啡杯的印渍，咳咳，请忽略它。）

祝 阅读愉快。
`
        },

        // === 第二周：文学 ===
        8: {
            title: "哈代！",
            sender: "糖水菠萝",
            content: `To 朋友：
正在开发
`
        },
        9: {
            title: "再聊聊理论",
            sender: "糖水菠萝",
            content: `To 朋友：
正在开发            
`
        },
        10: {
            title: "一个失败的人的故事（上）",
            sender: "糖水菠萝",
            content: `To 朋友：
正在开发
`
        },
        11: {
            title: "一个失败的人的故事（中）",
            sender: "糖水菠萝",
            content: `To 朋友：
正在开发
`
        },
        12: {
            title: "一个失败的人的故事（下）",
            sender: "糖水菠萝",
            content: `To 朋友：
正在开发
`
        },
        13: {
            title: "一个失败的人的故事？",
            sender: "糖水菠萝",
            content: `To 朋友：
正在开发
`
        },
        14: {
            title: "叙事与社会",
            sender: "糖水菠萝",
            content: `To 朋友：
正在开发
`
        },

        // === 第三周：游戏开发日志 === （除了最后一天明确要写什么内容外，其余天待定）
        15: {
            title: "？？？",
            sender: "糖水菠萝",
            content: `待定`
        },
        16: {
            title: "？？？",
            sender: "糖水菠萝",
            content: `待定`
        },
        17: {
            title: "？？？",
            sender: "糖水菠萝",
            content: `待定`
        },
        18: {
            title: "？？？",
            sender: "糖水菠萝",
            content: `待定`
        },
        19: {
            title: "？？？",
            sender: "糖水菠萝",
            content: `待定`
        },
        20: {
            title: "？？？",
            sender: "糖水菠萝",
            content: `待定`
        },
        21: {
            title: "尾声",
            sender: "糖水菠萝",
            content: `To ???:
            
今天是第21天。按照心理学的研究，21天可以养成一个新习惯。

但是，在落笔今天这封信的时候，一种奇怪的感觉到达了顶峰。

我一开始在抬头写着“To 新房客”，但我总感觉……你并不是那个我想象中、接着我租房合同的陌生人。

我不确定你是谁，所以我只能称呼你为“？？？”。

但我能感觉到，你此刻正透过某种发光的界面注视着我。也许你并没有坐在我的这把旧椅子上，也许你身处的房间比这里明亮得多，也许你所处的城市里没有一所名叫加里敦的学院。

但我确信，你在读，你在听。

这种感觉很荒谬，对吧？就像舞台上的演员突然停下来，盯着漆黑的观众席说：“我看见你了。”

但我不想骗你，也不想骗我自己。之前我总说“书写是为了构建自我”，但现在我发现，故事同样是因为被阅读才存在的——就像你读到了我的故事一样。

谢谢你，身处另一个世界的你。

买来的信纸都用完了。那就先告一段落吧！

现在，把目光从屏幕（或者纸张？）上移开吧。看看你身边的世界，拿其你自己的笔。

不再是作为“新房客”，而是作为你那个世界的叙事者。

去吧，去写你自己的故事。

——糖水菠萝`
        }
    },

    // ✨ 新增：21天读后感引导语配置 (你可以根据信件内容自定义)
    REFLECTION_PROMPTS: {
        1: "看着这封关于'开始'的信，你是否也想起了某个重新出发的时刻？",
        2: "关于'被遗忘的草稿'，你有想要找回的碎片吗？",
        3: "你觉得自己正活在哪个'剧本'里？",
        4: "你如何定义'成功'与'失败'？",
        // ... 中间的天数可以留空，代码会使用默认文案 ...
        21: "这是最后一封信了。现在的你，想对最初的自己说些什么？"
    },

    TOTAL_LETTER_DAYS: 21, // 总天数阈值

    /**
     * 检查今天是否有新信 (用于红点提示)
     */
    checkNewMail() {
        const day = UserData.state.day;
        const letter = this.letters[day];
        
        // 如果有信，且还没读过
        if (letter && !UserData.hasReadMail(day)) {
            // ✨ 关键点：这里我们手动把 day 拼进去了
            return { day: day, ...letter };
        }
        return null;
    },

    /**
     * 获取今天的信内容 (用于点击打开)
     */
    getTodayMail() {
        const day = UserData.state.day;
        const letter = this.letters[day];

        if (letter) {
            // 🛠️ 修复：这里之前直接返回了 letter，导致缺少 'day' 字段
            // 现在我们像上面一样，手动把 day 拼进去
            return { day: day, ...letter };
        }
        return null;
    },

    /**
     * ✨ 核心逻辑：处理“完成阅读”
     * 请在 UI 层（SidebarRenderer 或 Mail UI 的关闭按钮）中调用此函数
     * @param {number} day - 邮件的天数
     */
    onCloseMail(day) {
        // 1. 标记已读
        UserData.markMailAsRead(day);

        // 2. 定义“下一步要做什么” (即弹出读后感输入框)
        const nextStep = () => {
             const replies = UserData.getAllReplies();
             // 只有没写过感想时，才弹窗
             if (!replies[day]) {
                 this.startReflectionFlow(day);
             } else {
                 // 如果都做完了，顺便检查一下有没有 Day7 包裹之类的
                 StoryManager.checkDailyEvents();
             }
        };

        // 3. 尝试触发“自言自语”对话 (传入 nextStep 作为回调)
        // 如果有对话 (tryTrigger 返回 true)，StoryManager 会在播完后自动调用 nextStep
        // 如果没对话 (tryTrigger 返回 false)，我们需要手动立即调用 nextStep
        const hasReactionStory = StoryManager.tryTriggerMailReaction(day, nextStep);

        if (!hasReactionStory) {
            nextStep();
        }
    },

    /**
     * ✨ 新增：获取信件归档列表
     * 返回格式：[{ day: 1, title: "...", unlocked: true }, { day: 2, title: "待开发", unlocked: false } ...]
     */
    getMailArchive() {
        const currentDay = UserData.state.day;
        const list = [];
        const readMails = UserData.state.readMails || [];
        for (let d = currentDay; d >= 1; d--) {
            const letter = this.letters[d];
            const isRead = readMails.includes(d);
            if (letter) {
                list.push({
                    day: d,
                    title: letter.title,
                    sender: letter.sender,
                    content: letter.content,
                    type: 'letter',
                    isRead: isRead
                });
            } else {
                // 不显示空窗期的信，或者显示为“无信件”
                list.push({ day: d, title: "...", type: 'empty' });
            }
        }
        return list;
    },

    /**
     * ✨ 新增：开启读后感弹窗
     */
    startReflectionFlow(day) {
        const modal = document.getElementById('modal-mail-reflection');
        const promptEl = document.getElementById('reflection-prompt');
        const inputEl = document.getElementById('reflection-input');
        const btnSubmit = document.getElementById('btn-submit-reflection');
        const btnSkip = document.getElementById('btn-skip-reflection');

        if (!modal) return;

        // 设置引导语
        const promptText = this.REFLECTION_PROMPTS[day] || "此刻，你的脑海中浮现了什么...";
        promptEl.innerText = promptText;
        
        // 清空输入框
        inputEl.value = "";

        // 绑定事件 (先解绑旧事件防止多次触发)
        btnSubmit.onclick = null;
        btnSkip.onclick = null;

        btnSubmit.onclick = () => {
            const content = inputEl.value.trim();
            // 如果用户没填，给一个默认的留白文本
            this.finishReflection(day, content || "（以此沉默回应）"); 
        };

        btnSkip.onclick = () => {
            this.finishReflection(day, "（未记录感想）");
        };

        // 显示弹窗
        modal.style.display = 'flex';
    },

    /**
     * ✨ 新增：完成记录并保存
     */
    finishReflection(day, content) {
        // 1. 保存数据
        UserData.saveMailReply(day, content);
        
        // 2. 关闭弹窗
        document.getElementById('modal-mail-reflection').style.display = 'none';
        
        // 3. 反馈
        HUDRenderer.log("💭 思绪已记录。");

        // 4. 检查是否触发最终彩蛋 (集齐21天)
        this.checkEasterEgg();
    },

    /**
     * ✨ 新增：检查彩蛋逻辑
     */
    checkEasterEgg() {
        if (UserData.state.hasReceivedEasterEggBook) return;

        const replies = UserData.getAllReplies();
        // 简单判断：回复的数量是否达到总天数
        if (Object.keys(replies).length >= this.TOTAL_LETTER_DAYS) {
            this.generateTheBook();
        }
    },

    /**
     * ✨ 新增：生成那本“玩家与糖水菠萝的共同回忆录”
     */
    generateTheBook() {
        console.log("🎉 触发 21 天彩蛋！正在编纂书籍...");

        let bookContent = "# 伊萨卡回信集\n\n";
        bookContent += "致 亲爱的房客：\n\n当你读到这句话时，你已经陪伴我走过了漫长的旅途。这些是你留下的足迹。\n\n---\n\n";

        const replies = UserData.getAllReplies();

        for (let i = 1; i <= this.TOTAL_LETTER_DAYS; i++) {
            const reply = replies[i] || "（无记录）";
            const prompt = this.REFLECTION_PROMPTS[i] || `Day ${i} 的随想`;
            
            bookContent += `### Day ${i}\n`;
            bookContent += `> *${prompt}*\n\n`; // 引用当时的引导语
            bookContent += `${reply}\n\n`;      // 玩家的评论
            bookContent += `***\n\n`;           // 分割线
        }

        bookContent += "\n感谢你在伊萨卡的停留。\n—— 你的朋友 糖水菠萝";

        // 创建书籍对象
        const specialBook = {
            id: 'book_easter_egg_21',
            title: '21',
            author: '你 & 糖水菠萝',
            content: bookContent,
            cover: 'assets/images/booksheet/booksheet3.png', // 使用特殊的绿色封面
            isRare: true, 
            price: 9999
        };

        // 添加到图书馆
        Library.addBook(specialBook);
        
        // 标记已领取
        UserData.state.hasReceivedEasterEggBook = true;
        UserData.save();

        // 延迟一点弹出提示
        setTimeout(() => {
            alert("✨ 叮！书架上突然多了一本厚厚的书...\n\n恭喜获得隐藏书籍：《21》");
            HUDRenderer.log("🏆 获得珍藏书籍：《21》");
        }, 1500);
    },
};